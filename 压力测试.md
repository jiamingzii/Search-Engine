# 性能测试

---

## 1. 测试环境

| 项目 | 配置 |
|------|------|
| 操作系统 | Ubuntu 24.04 (Linux 6.8.0) |
| CPU | 2 核 |
| 内存 | 4 GB |
| 测试工具 | wrk 4.1.0 |
| 数据规模 | **100,000 篇文档**（去重后 70,761 篇） |
| 索引词数 | 515 个 |

---

## 2. 测试结果汇总

| 指标 | 数值 | 说明 |
|------|------|------|
| **索引构建耗时** | 102.5 秒 | 10万篇文档全量构建 |
| **内存占用** | 631 MB | 传统模式，全量加载 |
| **QPS** | **48,850** | 4线程，100并发连接 |
| **平均延迟** | 2.00 ms | Avg Latency |
| **P50 延迟** | 1.78 ms | 中位数延迟 |
| **P99 延迟** | 6.14 ms | 99分位延迟 |
| **吞吐量** | 362 MB/s | 响应数据传输速率 |
| **30秒总请求** | 1,469,710 次 | 无失败请求 |

---

## 3. 详细测试数据

### 3.1 索引构建性能

```
文档加载数: 100,000 篇
去重后文档数: 70,761 篇 (去重率 29.2%)
平均文档长度: 54.98 词
索引词数量: 515 个
索引构建耗时: 102.5 秒
```

**性能评估**：

- 构建速度约 976 篇/秒
- SimHash 去重有效过滤了约 30% 的重复内容

### 3.2 并发压力测试 (wrk)

```
测试参数: 4 线程, 100 并发连接, 30 秒持续时间
目标接口: GET /search?q=科技

Running 30s test @ http://localhost:8080/search?q=科技
  4 threads and 100 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     2.00ms    1.10ms  25.19ms   80.60%
    Req/Sec    12.28k     0.94k   20.49k    74.65%
  Latency Distribution
     50%    1.78ms
     75%    2.40ms
     90%    3.22ms
     99%    6.14ms
  1469710 requests in 30.09s, 10.64GB read
Requests/sec:  48850.35
Transfer/sec:    362.17MB
```

**性能评估**：
- **QPS 接近 5 万**，单机性能优秀
- **延迟稳定**，99% 请求在 6ms 内完成
- **零失败**，30秒压测无错误请求
- 延迟标准差低 (1.10ms)，服务稳定

### 3.3 延迟分布

| 分位数 | 延迟 |
|--------|------|
| P50 | 1.78 ms |
| P75 | 2.40 ms |
| P90 | 3.22 ms |
| P99 | 6.14 ms |
| Max | 25.19 ms |

### 3.4 内存占用

| 运行模式 | 内存占用 | 说明 |
|----------|----------|------|
| 传统模式 | 631 MB | 10万文档全量加载 |
| 轻量模式 | ~100 MB（预估） | 仅加载元数据 |

---

## 4. 性能优化措施

### 4.1 算法优化
- **BM25 排序算法**：相比 TF-IDF，对长文档和高频词有更好的处理
- **SimHash 去重**：O(1) 时间复杂度判断文档相似性，有效过滤 30% 重复内容

### 4.2 数据结构优化
- **unordered_map 倒排索引**：查询时间复杂度 O(1)
- **partial_sort 局部排序**：TopK 查询时间复杂度 O(N log K)
- **vector 替代 map 计分**：利用 CPU Cache，提升计算效率

### 4.3 缓存优化
- **分段锁 LRU 缓存**：16 分片，减少锁竞争
- **缓存命中率统计**：支持运行时监控

### 4.4 并发优化
- **基于 workflow 异步框架**：高效处理并发请求
- **无锁查询路径**：读操作不需要加锁

---

## 5. 扩展性分析

### 5.1 数据规模与性能关系

| 数据规模 | 索引构建时间 | 内存占用 | QPS |
|----------|-------------|----------|-----|
| 10 篇 | 0.6 秒 | 136 MB | 53,000+ |
| 50,000 篇 | 28 秒 | 253 MB | 48,000+ |
| **100,000 篇** | **102 秒** | **631 MB** | **48,850** |

### 5.2 性能结论
- QPS 随数据量增加略有下降，但仍保持在 5 万左右
- 内存占用与数据量基本呈线性关系
- 延迟保持稳定，P99 始终在 10ms 以内

### 5.3 水平扩展方案
- **多实例部署**：通过 Nginx 负载均衡分发请求
- **Redis 分布式缓存**：跨实例共享热点查询结果
- **索引分片**：按文档 ID 范围分片，并行搜索后合并

---

## 6. 结论

1. **高性能**：10万文档规模下，单机 QPS 达到 **48,850**，满足高并发场景
2. **低延迟**：P99 延迟仅 **6.14ms**，用户体验优秀
3. **稳定可靠**：30秒压测、147万次请求，**零失败**
4. **资源可控**：内存占用 631MB，在合理范围内
5. **可扩展**：支持轻量模式和分布式部署

---

## 附录：测试命令

```bash
# 安装测试工具
sudo apt-get install -y wrk

# 构建索引
./search_engine build

# 启动服务
./search_engine server &

# 运行压测
wrk -t4 -c100 -d30s --latency "http://localhost:8080/search?q=%E7%A7%91%E6%8A%80"

# 查看内存占用
ps aux | grep search_engine | grep -v grep | awk '{print $6/1024 " MB"}'

# 查看健康状态
curl http://localhost:8080/health
```
