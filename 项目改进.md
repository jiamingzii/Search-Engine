# é¡¹ç›®æ”¹è¿›è®¡åˆ’

æœ¬æ–‡æ¡£è®°å½•é¡¹ç›®çš„æ”¹è¿›è®¡åˆ’å’Œå®æ–½æ–¹æ¡ˆï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºã€‚

---

## æ”¹è¿›é¡¹æ€»è§ˆ

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | çŠ¶æ€ | é¢„è®¡å·¥æ—¶ |
|--------|--------|------|----------|
| ğŸ”´ å¿…åš | æ€§èƒ½æµ‹è¯•æŠ¥å‘Š | âœ… å·²å®Œæˆ | - |
| ğŸ”´ å¿…åš | æ¶æ„å›¾ | âœ… å·²å®Œæˆ | - |
| ğŸ”´ å¿…åš | ä¼˜åŒ–æ•…äº‹å‡†å¤‡ | âœ… å·²å®Œæˆ | - |
| ğŸŸ¡ å»ºè®® | å•å…ƒæµ‹è¯• | â¬œ å¾…å¼€å§‹ | 4 å°æ—¶ |
| ğŸŸ¡ å»ºè®® | æŠ€æœ¯åšå®¢ | â¬œ å¾…å¼€å§‹ | 3 å°æ—¶ |
| ğŸŸ¢ å¯é€‰ | å¢é‡ç´¢å¼• | â¬œ å¾…å¼€å§‹ | 8 å°æ—¶ |
| ğŸŸ¢ å¯é€‰ | Docker éƒ¨ç½² | â¬œ å¾…å¼€å§‹ | 2 å°æ—¶ |
| ğŸŸ¢ å¯é€‰ | Redis ç¼“å­˜ | â¬œ å¾…å¼€å§‹ | 4 å°æ—¶ |

---

## ğŸ”´ å¿…åšé¡¹ï¼ˆ1-2 å¤©å†…å®Œæˆï¼‰

### 1. æ€§èƒ½æµ‹è¯•æŠ¥å‘Š

**ç›®æ ‡**ï¼šç”¨æ•°æ®è¯æ˜é¡¹ç›®çš„æ€§èƒ½è¡¨ç°

**å®æ–½æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£…å‹æµ‹å·¥å…·
sudo apt-get install wrk apache2-utils

# 2. åˆ›å»ºæµ‹è¯•è„šæœ¬
cat > benchmark.sh << 'EOF'
#!/bin/bash

echo "=== ç´¢å¼•æ„å»ºæ€§èƒ½ ==="
time ./search_engine build

echo ""
echo "=== æŸ¥è¯¢æ€§èƒ½æµ‹è¯• ==="
echo "é¢„çƒ­..."
for i in {1..100}; do
    curl -s "http://localhost:8080/search?q=æµ‹è¯•" > /dev/null
done

echo "æ­£å¼æµ‹è¯• (30ç§’)..."
wrk -t4 -c100 -d30s "http://localhost:8080/search?q=æµ‹è¯•"

echo ""
echo "=== å†…å­˜å ç”¨ ==="
ps aux | grep search_engine | grep -v grep | awk '{print "Memory: " $6/1024 " MB"}'
EOF

chmod +x benchmark.sh
```

**æœŸæœ›è¾“å‡º**ï¼š

```
æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
============

æµ‹è¯•ç¯å¢ƒ
--------
- CPU: 4 æ ¸
- å†…å­˜: 8 GB
- æ•°æ®é‡: 10 ä¸‡ç½‘é¡µ

æµ‹è¯•ç»“æœ
--------
| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| ç´¢å¼•æ„å»º | 45 ç§’ |
| P50 å»¶è¿Ÿ | 5 ms |
| P99 å»¶è¿Ÿ | 20 ms |
| QPS | 2000+ |
| å†…å­˜ï¼ˆä¼ ç»Ÿï¼‰ | 1.8 GB |
| å†…å­˜ï¼ˆliteï¼‰ | 85 MB |
```

---

### 2. æ¶æ„å›¾

âœ… å·²åœ¨ README.md ä¸­å®Œæˆ

---

### 3. ä¼˜åŒ–æ•…äº‹å‡†å¤‡

âœ… å·²åœ¨ INTERVIEW_GUIDE.md ä¸­å®Œæˆ

---

## ğŸŸ¡ å»ºè®®åšé¡¹ï¼ˆ3-5 å¤©å†…å®Œæˆï¼‰

### 4. å•å…ƒæµ‹è¯•

**ç›®æ ‡**ï¼šå¢åŠ ä»£ç å¯ä¿¡åº¦ï¼Œå±•ç¤ºå·¥ç¨‹ç´ å…»

**å®æ–½æ­¥éª¤**ï¼š

1. å®‰è£… Google Testï¼š

```bash
sudo apt-get install libgtest-dev
cd /usr/src/gtest
sudo cmake .
sudo make
sudo cp lib/*.a /usr/lib
```

2. åˆ›å»ºæµ‹è¯•ç›®å½•å’Œæ–‡ä»¶ï¼š

```bash
mkdir -p test
```

3. ç¼–å†™æµ‹è¯•ç”¨ä¾‹ `test/test_lru_cache.cc`ï¼š

```cpp
#include <gtest/gtest.h>
#include "../include/LRUCache.h"
#include <thread>
#include <vector>

// åŸºæœ¬åŠŸèƒ½æµ‹è¯•
TEST(LRUCacheTest, BasicGetPut) {
    SearchCache cache(3);
    cache.put("a", "1");
    cache.put("b", "2");

    string val;
    EXPECT_TRUE(cache.get("a", val));
    EXPECT_EQ(val, "1");
    EXPECT_TRUE(cache.get("b", val));
    EXPECT_EQ(val, "2");
}

// æ·˜æ±°æµ‹è¯•
TEST(LRUCacheTest, Eviction) {
    SearchCache cache(2);
    cache.put("a", "1");
    cache.put("b", "2");
    cache.put("c", "3");  // åº”è¯¥æ·˜æ±°æŸä¸ªåˆ†ç‰‡ä¸­æœ€è€çš„

    // ç”±äºåˆ†æ®µé”ï¼Œæ·˜æ±°è¡Œä¸ºå–å†³äº hash åˆ†å¸ƒ
    // è‡³å°‘åº”è¯¥èƒ½å­˜ 2 ä¸ª
    EXPECT_LE(cache.size(), 3);
}

// æ›´æ–°æµ‹è¯•
TEST(LRUCacheTest, Update) {
    SearchCache cache(10);
    cache.put("a", "1");
    cache.put("a", "2");

    string val;
    EXPECT_TRUE(cache.get("a", val));
    EXPECT_EQ(val, "2");
}

// å¹¶å‘æµ‹è¯•
TEST(LRUCacheTest, ConcurrentAccess) {
    SearchCache cache(1000);
    std::vector<std::thread> threads;

    // 10 ä¸ªçº¿ç¨‹å¹¶å‘å†™å…¥
    for (int i = 0; i < 10; i++) {
        threads.emplace_back([&cache, i]() {
            for (int j = 0; j < 1000; j++) {
                cache.put(std::to_string(i * 1000 + j), "value");
            }
        });
    }

    for (auto& t : threads) t.join();

    // æ²¡æœ‰å´©æºƒå’Œæ­»é”å°±æ˜¯æˆåŠŸ
    EXPECT_GT(cache.size(), 0);
}

// å‘½ä¸­ç‡ç»Ÿè®¡æµ‹è¯•
TEST(LRUCacheTest, HitRate) {
    SearchCache cache(10);
    cache.put("a", "1");

    string val;
    cache.get("a", val);  // hit
    cache.recordQuery(true);
    cache.get("b", val);  // miss
    cache.recordQuery(false);

    EXPECT_EQ(cache.hitRate(), 0.5);
}

int main(int argc, char **argv) {
    testing::InitGoogleTest(&argc, argv);
    return RUN_ALL_TESTS();
}
```

4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹ `test/test_bm25.cc`ï¼š

```cpp
#include <gtest/gtest.h>
#include "../include/InvertIndex.h"
#include "../include/WebPage.h"
#include "../include/SplitTool.h"
#include <cmath>

class BM25Test : public ::testing::Test {
protected:
    void SetUp() override {
        // åˆå§‹åŒ–åˆ†è¯å·¥å…·å’Œç´¢å¼•
    }
};

// IDF è®¡ç®—æµ‹è¯•
TEST(BM25Test, IDFCalculation) {
    // df=1, N=100 æ—¶ï¼ŒIDF åº”è¯¥è¾ƒé«˜
    // df=50, N=100 æ—¶ï¼ŒIDF åº”è¯¥è¾ƒä½
    InvertIndex index;
    // é€šè¿‡ public æ¥å£æµ‹è¯• BM25 è¡Œä¸º
}

// æ’åºæ­£ç¡®æ€§æµ‹è¯•
TEST(BM25Test, RankingOrder) {
    // åŒ…å«æŸ¥è¯¢è¯æ›´å¤šçš„æ–‡æ¡£åº”è¯¥æ’åœ¨å‰é¢
}
```

5. æ·»åŠ  Makefile æµ‹è¯•ç›®æ ‡ï¼š

```makefile
# æ·»åŠ åˆ° Makefile
TEST_SRCS = test/test_lru_cache.cc
TEST_OBJS = $(TEST_SRCS:.cc=.o)

test: $(TEST_OBJS)
	$(CXX) $(CXXFLAGS) -o run_tests $(TEST_OBJS) -lgtest -lgtest_main -lpthread
	./run_tests

.PHONY: test
```

---

### 5. æŠ€æœ¯åšå®¢

**ç›®æ ‡**ï¼šå¢åŠ æ›å…‰ï¼Œå±•ç¤ºè¡¨è¾¾èƒ½åŠ›

**å»ºè®®å‘å¸ƒå¹³å°**ï¼š
- æ˜é‡‘
- CSDN
- çŸ¥ä¹ä¸“æ 
- ä¸ªäººåšå®¢

**æ–‡ç« å¤§çº²**ï¼š

```markdown
# ä»é›¶å®ç°ä¸€ä¸ªé«˜æ€§èƒ½æœç´¢å¼•æ“ï¼ˆC++ï¼‰

## å‰è¨€
- ä¸ºä»€ä¹ˆåšè¿™ä¸ªé¡¹ç›®
- é¡¹ç›®èƒ½è¾¾åˆ°ä»€ä¹ˆæ•ˆæœ

## æ•´ä½“æ¶æ„
- æ¶æ„å›¾
- æ¨¡å—åˆ’åˆ†
- æ•°æ®æµ

## æ ¸å¿ƒç®—æ³•è¯¦è§£

### BM25 æ’åº
- TF-IDF çš„ä¸è¶³
- BM25 çš„æ”¹è¿›
- ä»£ç å®ç°

### SimHash å»é‡
- åŸç†è®²è§£
- æ±‰æ˜è·ç¦»
- å®é™…æ•ˆæœ

## æ€§èƒ½ä¼˜åŒ–å®æˆ˜

### åˆ†æ®µé” LRU
- é—®é¢˜å‘ç°
- è§£å†³æ–¹æ¡ˆ
- æ•ˆæœå¯¹æ¯”

### å†…å­˜ä¼˜åŒ–
- é—®é¢˜åˆ†æ
- åˆ†ç¦»å­˜å‚¨æ–¹æ¡ˆ
- æ•ˆæœå¯¹æ¯”

## è¸©å‘è®°å½•
- å‘1: xxx
- å‘2: xxx

## æ€»ç»“
- å­¦åˆ°äº†ä»€ä¹ˆ
- æœªæ¥å±•æœ›

## æºç 
- GitHub é“¾æ¥
```

---

## ğŸŸ¢ å¯é€‰åšé¡¹ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰

### 6. å¢é‡ç´¢å¼•æ”¯æŒ

**ç›®æ ‡**ï¼šæ”¯æŒå®æ—¶æ·»åŠ æ–‡æ¡£ï¼Œä¸éœ€è¦å…¨é‡é‡å»º

**è®¾è®¡æ–¹æ¡ˆ**ï¼š

```cpp
// InvertIndex.h æ·»åŠ 
class InvertIndex {
public:
    // å¢é‡æ·»åŠ æ–‡æ¡£
    void addDocument(shared_ptr<WebPage> page);

    // æ ‡è®°åˆ é™¤æ–‡æ¡£
    void removeDocument(int docId);

    // åå°åˆå¹¶ï¼ˆå®šæœŸæ‰§è¡Œï¼‰
    void merge();

private:
    // ä¸»ç´¢å¼•ï¼ˆåªè¯»ï¼Œå¤§ï¼‰
    unordered_map<string, vector<InvertIndexItem>> _mainIndex;

    // å¢é‡ç´¢å¼•ï¼ˆè¯»å†™ï¼Œå°ï¼‰
    unordered_map<string, vector<InvertIndexItem>> _deltaIndex;
    mutex _deltaMutex;

    // åˆ é™¤é›†åˆ
    unordered_set<int> _deletedDocs;
    mutex _deleteMutex;
};

// æŸ¥è¯¢æ—¶åˆå¹¶ä¸¤ä¸ªç´¢å¼•çš„ç»“æœ
vector<pair<int, double>> InvertIndex::search(...) {
    // 1. æŸ¥ä¸»ç´¢å¼•
    // 2. æŸ¥å¢é‡ç´¢å¼•
    // 3. è¿‡æ»¤å·²åˆ é™¤æ–‡æ¡£
    // 4. åˆå¹¶æ’åº
}
```

---

### 7. Docker éƒ¨ç½²

**ç›®æ ‡**ï¼šä¸€é”®éƒ¨ç½²ï¼Œæ–¹ä¾¿æ¼”ç¤º

**Dockerfile**ï¼š

```dockerfile
FROM ubuntu:22.04

# å®‰è£…ä¾èµ–
RUN apt-get update && apt-get install -y \
    g++ make libssl-dev git cmake

# å®‰è£… workflow
RUN git clone https://github.com/sogou/workflow.git /workflow && \
    cd /workflow && make -j4 && make install

# å®‰è£… wfrest
RUN git clone https://github.com/wfrest/wfrest.git /wfrest && \
    cd /wfrest && make -j4 && make install

# å¤åˆ¶é¡¹ç›®
WORKDIR /app
COPY . .

# ç¼–è¯‘
RUN make clean && make

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¯åŠ¨å‘½ä»¤
CMD ["./search_engine", "server"]
```

**docker-compose.yml**ï¼š

```yaml
version: '3'
services:
  search:
    build: .
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
      - ./conf:/app/conf
    restart: unless-stopped
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```bash
# æ„å»ºé•œåƒ
docker-compose build

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

---

### 8. Redis ç¼“å­˜

**ç›®æ ‡**ï¼šæ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜ï¼Œæé«˜å¯æ‰©å±•æ€§

**è®¾è®¡æ–¹æ¡ˆ**ï¼š

```cpp
// RedisCache.h
class RedisCache {
public:
    RedisCache(const string& host, int port);

    bool get(const string& key, string& value);
    void put(const string& key, const string& value, int ttl = 3600);

private:
    // ä½¿ç”¨ hiredis æˆ– redis-plus-plus
};

// SearchServer ä¸­ä½¿ç”¨
class SearchServer {
    // äºŒçº§ç¼“å­˜ï¼šæœ¬åœ° LRU + Redis
    shared_ptr<SearchCache> _localCache;
    shared_ptr<RedisCache> _redisCache;

    string handleSearch(const string& query) {
        string result;

        // L1: æœ¬åœ°ç¼“å­˜
        if (_localCache->get(query, result)) {
            return result;
        }

        // L2: Redis
        if (_redisCache && _redisCache->get(query, result)) {
            _localCache->put(query, result);
            return result;
        }

        // å®é™…æœç´¢
        result = doSearch(query);

        // å†™å…¥ç¼“å­˜
        _localCache->put(query, result);
        if (_redisCache) {
            _redisCache->put(query, result);
        }

        return result;
    }
};
```

---

## æ”¹è¿›æ£€æŸ¥æ¸…å•

é¢è¯•å‰ç¡®ä¿å®Œæˆä»¥ä¸‹æ£€æŸ¥ï¼š

- [ ] èƒ½æµç•…è®²è¿° 3 ä¸ªä¼˜åŒ–æ•…äº‹
- [ ] èƒ½æ‰‹å†™ BM25 å…¬å¼
- [ ] èƒ½è§£é‡Šåˆ†æ®µé”åŸç†å’Œç¼ºç‚¹
- [ ] èƒ½å›ç­”"1 äº¿æ•°æ®æ€ä¹ˆåŠ"
- [ ] æœ‰æ€§èƒ½æµ‹è¯•æ•°æ®æ”¯æ’‘
- [ ] ä»£ç èƒ½æ­£å¸¸ç¼–è¯‘è¿è¡Œ
- [ ] èƒ½ç°åœºæ¼”ç¤ºæœç´¢åŠŸèƒ½
