# Engine 搜索引擎 - 项目架构全景图

## 一、系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Engine 搜索引擎系统                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────── 表现层 ──────────────────────────────────────┐   │
│  │                                                                              │   │
│  │   ┌──────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  SearchServer (HTTP服务)                                              │  │   │
│  │   │  ├─ GET /search?q=xxx  → 搜索接口 (返回JSON)                          │  │   │
│  │   │  ├─ GET /suggest?q=xxx → 关键词推荐接口                               │  │   │
│  │   │  ├─ GET /health        → 健康检查 (缓存命中率)                        │  │   │
│  │   │  └─ GET /              → 前端搜索页面                                 │  │   │
│  │   │  [基于 wfrest 框架, 监听 0.0.0.0:8080]                                │  │   │
│  │   └──────────────────────────────────────────────────────────────────────┘  │   │
│  │                           ↓ 调用                                            │   │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │   │  static/index.html (前端页面)                                        │   │   │
│  │   │  └─ Fetch API 异步请求 → 展示搜索结果                                 │   │   │
│  │   └─────────────────────────────────────────────────────────────────────┘   │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                            │
│                                        ↓ 依赖                                       │
│  ┌─────────────────────────────── 业务逻辑层 ────────────────────────────────────┐  │
│  │                                                                               │  │
│  │  ┌─────────────────┐    ┌──────────────────┐    ┌───────────────────────┐    │  │
│  │  │   LRUCache      │    │  InvertIndex     │    │ KeywordRecommender    │    │  │
│  │  │   (搜索缓存)     │    │  (倒排索引)       │    │ (关键词推荐)          │    │  │
│  │  │                 │    │                  │    │                       │    │  │
│  │  │ • 容量: 1000    │    │ • BM25 权重计算   │    │ • 编辑距离算法        │    │  │
│  │  │ • 16分片锁      │    │ • k1=1.2, b=0.75 │    │ • 候选词排序          │    │  │
│  │  │ • 命中率统计    │    │ • 按权重排序      │    │ • TopK 推荐           │    │  │
│  │  │ • 线程安全      │    │ • 二进制序列化    │    │ • UTF-8 字符处理      │    │  │
│  │  └────────┬────────┘    └────────┬─────────┘    └───────────┬───────────┘    │  │
│  │           │                      │                          │                │  │
│  │           └──────────────────────┼──────────────────────────┘                │  │
│  │                                  ↓ 依赖                                       │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                            │
│                                        ↓                                            │
│  ┌─────────────────────────────── 数据访问层 ────────────────────────────────────┐  │
│  │                                                                               │  │
│  │  ┌─────────────────────┐        ┌──────────────────────┐                     │  │
│  │  │     PageLib         │        │   DictProducer       │                     │  │
│  │  │   (网页库管理)       │        │   (词典生成器)        │                     │  │
│  │  │                     │        │                      │                     │  │
│  │  │ • 加载 XML 文档      │        │ • 词频统计            │                     │  │
│  │  │ • 管理 WebPage 列表  │        │ • 字符索引构建        │                     │  │
│  │  │ • 分离存储(lite)    │        │ • UTF-8 拆字          │                     │  │
│  │  └──────────┬──────────┘        └───────────┬──────────┘                     │  │
│  │             │                               │                                 │  │
│  │             ↓ 使用                          ↓ 依赖                            │  │
│  │  ┌──────────────────────────────────────────────────────────────────────┐    │  │
│  │  │                        WebPage (文档对象)                             │    │  │
│  │  │                                                                      │    │  │
│  │  │  属性: docId | title | url | content | wordsMap(词频)                │    │  │
│  │  │  方法: processDoc() | getSimhash() | getSummary() | hammingDistance()│    │  │
│  │  └──────────────────────────────────────────────────────────────────────┘    │  │
│  │                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                        │                                            │
│                                        ↓                                            │
│  ┌─────────────────────────────── 工具/基础层 ───────────────────────────────────┐  │
│  │                                                                               │  │
│  │  ┌───────────────────────┐    ┌────────────────────────────────────────────┐ │  │
│  │  │ PageLibPreprocessor   │    │           SplitTool (分词工具)              │ │  │
│  │  │    (预处理器)          │    │                                            │ │  │
│  │  │                       │    │  ┌──────────────────────────────────────┐  │ │  │
│  │  │ • SimHash 计算        │    │  │      JiebaSplitTool (具体实现)       │  │ │  │
│  │  │ • 汉明距离判重        │←───│  │                                      │  │ │  │
│  │  │ • 阈值: 3 bits        │    │  │  • 封装 cppjieba (pImpl 模式)        │  │ │  │
│  │  └───────────────────────┘    │  │  • 停用词过滤                        │  │ │  │
│  │                               │  │  • vector<string> cut(sentence)     │  │ │  │
│  │                               │  └──────────────────────────────────────┘  │ │  │
│  │                               └────────────────────────────────────────────┘ │  │
│  │                                                                               │  │
│  │  ┌──────────────────────────────────────────────────────────────────────────┐│  │
│  │  │                    Configuration (配置管理 - 单例模式)                    ││  │
│  │  │                                                                          ││  │
│  │  │  配置项: server_ip | server_port | data_path | index_path | cache_size  ││  │
│  │  │          dict_path | model_path | idf_path | stop_word_path              ││  │
│  │  └──────────────────────────────────────────────────────────────────────────┘│  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、模块依赖关系图

```
                          ┌─────────────┐
                          │   main.cc   │
                          └──────┬──────┘
                                 │
           ┌─────────────────────┼─────────────────────┐
           │                     │                     │
           ↓                     ↓                     ↓
   ┌───────────────┐    ┌───────────────┐    ┌───────────────┐
   │ Configuration │    │  build 模式   │    │ server 模式   │
   │   (单例)      │    └───────┬───────┘    └───────┬───────┘
   └───────────────┘            │                    │
           ↑                    │                    │
           │                    ↓                    ↓
           │           ┌────────────────┐   ┌────────────────┐
           └───────────│    PageLib     │   │  SearchServer  │
                       │  (加载 XML)    │   │  (HTTP 服务)   │
                       └────────┬───────┘   └───────┬────────┘
                                │                   │
                                ↓                   │
                    ┌───────────────────────┐       │
                    │ PageLibPreprocessor   │       │
                    │   (SimHash 去重)      │       │
                    └───────────┬───────────┘       │
                                │                   │
                                ↓                   │
                       ┌────────────────┐           │
                       │  InvertIndex   │←──────────┤
                       │ (BM25 索引)    │           │
                       └────────┬───────┘           │
                                │                   │
                                ↓                   │
                       ┌────────────────┐           │
                       │ DictProducer   │←──────────┤
                       │  (词典生成)    │           │
                       └────────┬───────┘           │
                                │                   │
                                ↓                   ↓
                    ┌───────────────────────────────────┐
                    │       KeywordRecommender          │
                    │     (编辑距离 + TopK 推荐)         │
                    └───────────────────────────────────┘
                                        ↑
                                        │
                    ┌───────────────────────────────────┐
                    │           LRUCache               │
                    │      (查询结果缓存)               │
                    └───────────────────────────────────┘

        ═══════════════════════════════════════════════════
                        所有模块共同依赖
        ═══════════════════════════════════════════════════
                                ↓
                    ┌───────────────────────────────────┐
                    │    SplitTool / JiebaSplitTool     │
                    │         (中文分词)                │
                    └───────────────────────────────────┘
                                ↓
                    ┌───────────────────────────────────┐
                    │          WebPage                  │
                    │   (文档对象 + SimHash 计算)        │
                    └───────────────────────────────────┘
```

---

## 三、数据流向图

### 3.1 离线构建流程 (build 模式)

```
  data/*.xml                     cppjieba词典
       │                              │
       ↓                              ↓
  ┌─────────────┐              ┌─────────────┐
  │  PageLib    │──────────────│  SplitTool  │
  │  加载文档    │    分词       │  中文分词    │
  └──────┬──────┘              └─────────────┘
         │
         ↓ 创建 WebPage 对象
  ┌─────────────────────────────────────────────────────────────────┐
  │                         WebPage[]                                │
  │  每个文档: docId, title, url, content, wordsMap(词→频)          │
  └─────────────────────────────┬───────────────────────────────────┘
                                │
         ┌──────────────────────┴──────────────────────┐
         ↓                                             ↓
  ┌─────────────────┐                         ┌─────────────────┐
  │ Preprocessor    │                         │  DictProducer   │
  │ SimHash去重     │                         │  词典统计        │
  │ 汉明距离<3剔除   │                         │  字符索引构建    │
  └────────┬────────┘                         └────────┬────────┘
           │                                           │
           ↓                                           ↓
  ┌─────────────────┐                         ┌─────────────────┐
  │ processedPages  │                         │ dict.dat        │
  │ (去重后的文档)   │                         │ dict_index.dat  │
  └────────┬────────┘                         └─────────────────┘
           │
           ↓
  ┌─────────────────────────────────────────────────────────────────┐
  │                       InvertIndex 构建                          │
  │                                                                 │
  │  Step 1: 统计 DF (文档频率)                                      │
  │  Step 2: 计算文档长度 & 平均长度                                  │
  │  Step 3: 计算 BM25 权重                                          │
  │          IDF × (TF×(k1+1)) / (TF + k1×(1-b+b×len/avgLen))      │
  │  Step 4: 按权重排序倒排列表                                      │
  └─────────────────────────────┬───────────────────────────────────┘
                                │
                                ↓
                       ┌─────────────────┐
                       │   index.dat     │
                       │  (倒排索引文件)  │
                       └─────────────────┘
```

### 3.2 在线查询流程 (server 模式)

```
                    浏览器请求: GET /search?q=科技
                                 │
                                 ↓
  ┌────────────────────────────────────────────────────────────────────────┐
  │                         SearchServer                                   │
  │                                                                        │
  │   ①  URL解码: %E7%A7%91%E6%8A%80 → "科技"                              │
  │                          │                                             │
  │                          ↓                                             │
  │   ②  检查 LRUCache ──→ 命中? ──→ 直接返回缓存结果                       │
  │                          │                                             │
  │                          ↓ 未命中                                       │
  │   ③  SplitTool.cut("科技") → ["科技"]                                  │
  │                          │                                             │
  │                          ↓                                             │
  │   ④  InvertIndex.search(["科技"]) → [(docId:1, score:3.6), ...]       │
  │                          │                                             │
  │                          ↓                                             │
  │   ⑤  PageLib.getPage(docId) → WebPage对象                             │
  │       WebPage.getSummary(queryWords) → 摘要                            │
  │                          │                                             │
  │                          ↓                                             │
  │   ⑥  生成 JSON 响应                                                    │
  │       {                                                                │
  │         "query": "科技",                                               │
  │         "total": 20,                                                   │
  │         "results": [{docId, title, url, summary, score}, ...]         │
  │       }                                                                │
  │                          │                                             │
  │                          ↓                                             │
  │   ⑦  存入 LRUCache                                                     │
  └────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ↓
                           JSON 响应返回
```

---

## 四、文件结构总览

```
Engine/
├── include/                          # 头文件 (接口定义)
│   ├── Configuration.h              # 配置管理 [单例模式]
│   ├── SplitTool.h                  # 分词接口 [策略模式 + pImpl]
│   ├── WebPage.h                    # 文档类 [SimHash]
│   ├── WebPageMeta.h                # 轻量元数据 [内存优化]
│   ├── PageLib.h                    # 文档库管理
│   ├── PageLibPreprocessor.h        # 去重预处理
│   ├── InvertIndex.h                # 倒排索引 [BM25]
│   ├── SearchServer.h               # HTTP服务 [wfrest]
│   ├── DictProducer.h               # 词典生成
│   ├── KeywordRecommender.h         # 关键词推荐 [编辑距离]
│   └── LRUCache.h                   # LRU缓存 [分段锁]
│
├── src/                              # 实现文件
│   ├── main.cc                      # 入口 (build/server/server-lite)
│   ├── Configuration.cc
│   ├── SplitTool.cc                 # cppjieba封装
│   ├── WebPage.cc                   # XML解析 + SimHash
│   ├── PageLib.cc                   # 目录遍历 + 分离存储
│   ├── PageLibPreprocessor.cc       # 去重逻辑
│   ├── InvertIndex.cc               # BM25计算
│   ├── SearchServer.cc              # HTTP路由 + URL解码
│   ├── DictProducer.cc              # 词典构建
│   └── KeywordRecommender.cc        # 推荐算法
│
├── conf/
│   └── search.conf                  # 配置文件
│
├── data/
│   ├── news_100000.xml              # 测试语料 (10万篇新闻)
│   ├── index.dat                    # 倒排索引
│   ├── pagelib.dat                  # 网页库
│   ├── pagelib.dat.meta             # 元数据 (lite模式)
│   ├── pagelib.dat.content          # 正文内容 (lite模式)
│   ├── dict.dat                     # 词典文件
│   └── dict_index.dat               # 字符索引
│
├── static/
│   └── index.html                   # 前端搜索页面
│
├── benchmark.sh                     # 性能测试脚本
├── Makefile                         # 编译配置
├── README.md                        # 项目说明
├── 压力测试.md                       # 性能测试报告 (QPS 48850)
├── 项目改进.md                       # 改进计划
├── 项目结构.md                       # 本文档
├── 学习顺序.txt                      # 代码阅读顺序
└── 面试指导.md                       # 面试准备指南
```

---

## 五、核心模块功能说明

| 模块 | 文件 | 核心功能 | 设计模式 |
|------|------|----------|----------|
| **Configuration** | Configuration.h/cc | 加载配置文件，全局配置管理 | 单例模式 |
| **SplitTool** | SplitTool.h/cc | 中文分词，封装cppjieba | 策略模式 + pImpl |
| **WebPage** | WebPage.h/cc | 文档解析，SimHash计算，摘要生成 | - |
| **WebPageMeta** | WebPageMeta.h | 轻量元数据，配合磁盘存储 | - |
| **PageLib** | PageLib.h/cc | 加载XML文档，管理WebPage列表 | - |
| **PageLibPreprocessor** | PageLibPreprocessor.h/cc | SimHash去重，汉明距离判断 | - |
| **InvertIndex** | InvertIndex.h/cc | BM25权重计算，倒排索引构建/查询 | - |
| **DictProducer** | DictProducer.h/cc | 词频统计，字符索引构建 | - |
| **KeywordRecommender** | KeywordRecommender.h/cc | 编辑距离计算，TopK推荐 | - |
| **LRUCache** | LRUCache.h | 16分片缓存，O(1)读写 | 模板类 |
| **SearchServer** | SearchServer.h/cc | HTTP服务，URL解码，JSON响应 | - |

---

## 六、核心算法一览

| 算法 | 用途 | 所在模块 | 复杂度 |
|------|------|----------|--------|
| **BM25** | 搜索结果排序 | InvertIndex | O(n) |
| **SimHash** | 文档去重 | WebPage | O(词数) |
| **汉明距离** | 相似度判断 | WebPage | O(1) |
| **编辑距离** | 关键词推荐 | KeywordRecommender | O(m×n) |
| **LRU** | 热门查询缓存 | LRUCache | O(1) |

### BM25 公式

```
BM25(q, d) = Σ IDF(qi) × (TF(qi,d) × (k1 + 1)) / (TF(qi,d) + k1 × (1 - b + b × L(d) / L_avg))

其中:
- IDF(qi) = log((N - n(qi) + 0.5) / (n(qi) + 0.5) + 1)
- k1 = 1.2 (词频饱和参数)
- b = 0.75 (文档长度归一化参数)
- N = 总文档数
- n(qi) = 包含词qi的文档数
- L(d) = 文档d的长度
- L_avg = 平均文档长度
```

### SimHash 去重

```
1. 对文档分词得到 words[]
2. 初始化 hashVector[64] = 0
3. for each word in words:
     hash = Jenkins_Hash(word)
     for i in 0..63:
         if (hash & (1 << i)):
             hashVector[i] += word_frequency
         else:
             hashVector[i] -= word_frequency
4. simHash = 0
   for i in 0..63:
       if hashVector[i] > 0:
           simHash |= (1 << i)
5. 两个文档相似 <=> hammingDistance(simHash1, simHash2) < 3
```

---

## 七、运行方式

### 构建索引

```bash
make clean && make all
./search_engine build
```

### 启动服务

```bash
# 传统模式 (全内存)
./search_engine server

# 轻量模式 (内存优化)
./search_engine server-lite
```

### 访问接口

| 接口 | URL | 说明 |
|------|-----|------|
| 搜索 | `http://localhost:8080/search?q=科技` | 返回JSON搜索结果 |
| 推荐 | `http://localhost:8080/suggest?q=搜索` | 返回推荐词列表 |
| 健康检查 | `http://localhost:8080/health` | 返回缓存状态 |
| 前端页面 | `http://localhost:8080/` | 搜索界面 |

---

## 八、性能指标

> 测试环境：2 核 4G 虚拟机，10 万篇文档

| 指标 | 数值 |
|------|------|
| 索引构建时间 | 102 秒 |
| 查询延迟 P50 | 1.78 ms |
| 查询延迟 P99 | 6.14 ms |
| 吞吐量 QPS | **48,850** |
| 内存占用（传统模式） | 631 MB |
| 内存占用（轻量模式） | ~100 MB |
